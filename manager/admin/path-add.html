<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>欢迎页面-X-admin2.0</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width,user-scalable=yes, minimum-scale=0.4, initial-scale=0.8,target-densitydpi=low-dpi" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="stylesheet" href="./css/font.css">
    <link rel="stylesheet" href="./css/xadmin.css">
    <!-- 让IE8/9支持媒体查询，从而兼容栅格 -->
    <!--[if lt IE 9]>
    <script src="https://cdn.staticfile.org/html5shiv/r29/html5.min.js"></script>
    <script src="https://cdn.staticfile.org/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>

<body>
<div class="x-body">
    <form class="layui-form">
        <div class="layui-form-item">
            <label for="lb" class="layui-form-label">
                <span class="x-red">*</span>请求方式
            </label>
            <div class="layui-input-inline">
                <select id="req_method" name="req_method" class="valid">
                    <option value="GET">GET</option>
                    <option value="POST">POST</option>
                    <option value="PUT">PUT</option>
                    <option value="PATCH">PATCH</option>
                    <option value="DELETE">DELETE</option>
                    <option value="OPTIONS">OPTIONS</option>
                    <option value="HEAD">HEAD</option>
                </select>
            </div>
        </div>
        <div class="layui-form-item">
            <label for="domain_url" class="layui-form-label">
                <span class="x-red">*</span>路径
            </label>
            <div class="layui-input-block">
                <input type="text" id="req_path" name="req_path" lay-verify="reqPath" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label for="lb" class="layui-form-label">熔断</label>
            <div class="layui-input-inline">
                <input type="text" id="circuit_breaker_request" name="circuit_breaker_request"
                       class="layui-input" placeholder="请求数" lay-verify="circuitBreaker">
            </div>
            <div class="layui-input-inline">
                <input type="text" id="circuit_breaker_percent" name="circuit_breaker_percent"
                       class="layui-input" placeholder="阈值触发百分比" lay-verify="circuitBreaker">
            </div>
            <div class="layui-input-inline">
                <input type="text" id="circuit_breaker_timeout" name="circuit_breaker_timeout"
                       class="layui-input" placeholder="超时时间(单位毫秒)" >
            </div>
            <div class="layui-input-inline">
                <label class="layui-form-label">开启熔断</label>
                <input type="checkbox" id="circuit_breaker_enabled" name="circuit_breaker_enabled" verify="circuitBreakerSwitch"
                       lay-skin="switch" lay-text="ON|OFF">
            </div>

            <div class="layui-input-inline">
                <label class="layui-form-label">强制熔断</label>
                <input type="checkbox" id="circuit_breaker_force" name="circuit_breaker_force"
                       lay-skin="switch" lay-text="ON|OFF">
            </div>
        </div>
        <div class="layui-form-item">
            <label for="lb" class="layui-form-label"></label>
            <div class="layui-input-block">
                <textarea name="circuit_breaker_msg" id="circuit_breaker_msg" placeholder="自定义熔断返回结果" class="layui-textarea"></textarea>
            </div>
        </div>
        <div class="layui-form-item">
            <label for="L_repass" class="layui-form-label">
            </label>
            <button class="layui-btn" lay-submit lay-filter="sub">提交</button>
        </div>
    </form>
</div>
<script type="text/javascript" src="https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
<script type="text/javascript" src="./lib/layui/layui.js" charset="utf-8"></script>
<script type="text/javascript" src="./js/xadmin.js"></script>
<script type="text/javascript" src="./js/admin.js"></script>

<script>
    var domain_id = getUrlParam("domain_id");
    if(domain_id == "") {
        layer.alert("无域名id数据", {icon: 2}, function () {
            parent.refresh();
            x_admin_close();
        });
    }

    layui.use(['form','layer'], function(){
        var form = layui.form,layer = layui.layer;
        form.verify({
            reqPath: function(value) {
                if(value.indexOf("/") != 0) {
                    return "请输入/开头的路径"
                }
            },
            circuitBreaker: function(value) {
                if($("#circuit_breaker_enabled").is(':checked')) {
                    if (!new RegExp("^(0|[1-9][0-9]*)$").test(value)) {
                        return '请输入正整数';
                    }
                }
            },
            circuitBreakerSwitch: function (value) {
                if($("#circuit_breaker_enabled").is(':checked')) {
                    var circuit_breaker_request = $("#circuit_breaker_request").val();
                    var circuit_breaker_percent = $("#circuit_breaker_percent").val();
                    if(circuit_breaker_request <= 0 || circuit_breaker_percent <= 0) {
                        return '请输入熔断参数';
                    }
                }
            }
        });
        form.on('submit(sub)', function(data){
            var req_path = $("#req_path").val();
            var req_method = $("#req_method").val();
            var circuit_breaker_request = $("#circuit_breaker_request").val();
            var circuit_breaker_percent = $("#circuit_breaker_percent").val();
            var circuit_breaker_timeout = $("#circuit_breaker_timeout").val();
            var circuit_breaker_msg = $("#circuit_breaker_msg").val();
            var circuit_breaker_enabled = $("#circuit_breaker_enabled").is(':checked');
            var circuit_breaker_force = $("#circuit_breaker_force").is(':checked');

            var params = {
                req_path: req_path,
                req_method: req_method,
                circuit_breaker_request: circuit_breaker_request,
                circuit_breaker_percent: circuit_breaker_percent,
                circuit_breaker_timeout: circuit_breaker_timeout,
                circuit_breaker_msg: circuit_breaker_msg,
                circuit_breaker_enabled: circuit_breaker_enabled,
                circuit_breaker_force: circuit_breaker_force,
            };

            request("POST", HGW_MANAGE_API + "domains/"+domain_id+"/paths/", "json", false, params,
                    function(rsp) {
                        if (rsp.status == 1) {
                            layer.alert("增加成功", {icon: 6}, function () {
                                parent.refresh();
                                var index = parent.layer.getFrameIndex(window.name);
                                parent.layer.close(index);
                            });
                        } else {
                            layer.alert("失败");
                        }
                    });
            return false;
        });
    });
</script>
</body>
</html>